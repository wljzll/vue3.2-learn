{
  "version": 3,
  "sources": ["../src/index.ts", "../../shared/src/index.ts", "../src/effect.ts", "../src/reactive.ts"],
  "sourcesContent": ["export { reactive } from './reactive';\r\nexport { effect } from './effect';\r\n", "export function isObject(value: unknown): value is Record<any, any> {\r\n  return typeof value === 'object' && value !== null;\r\n}\r\n", "export let activeEffect = undefined; // \u5F53\u524D\u6B63\u5728\u6267\u884C\u7684effect\r\n\r\nclass ReactiveEffect {\r\n  active = true;\r\n  deps = []; // \u6536\u96C6effect\u4E2D\u4F7F\u7528\u5230\u7684\u5C5E\u6027\r\n  parent = undefined;\r\n  constructor(public fn) {}\r\n  run() {\r\n    if (!this.active) {\r\n      // ???\r\n      // \u4E0D\u662F\u6FC0\u6D3B\u72B6\u6001\r\n      return this.fn();\r\n    }\r\n\r\n    try {\r\n      this.parent = activeEffect;\r\n      console.log(this.parent, 'parent*************');\r\n      activeEffect = this;\r\n      console.log(activeEffect, 'activeEffect###################');\r\n      console.log(this.parent, 'parent*************############');\r\n      return this.fn();\r\n    } finally {\r\n      activeEffect = this.parent;\r\n      this.parent = undefined;\r\n    }\r\n  }\r\n}\r\n\r\nexport function effect(fn, options?) {\r\n  // \u4F7F\u7528effect\u65B9\u6CD5\r\n  const _effect = new ReactiveEffect(fn); // \u521B\u5EFAReactiveEffect\u5B9E\u4F8B\r\n  _effect.run(); // \u6267\u884Crun\u65B9\u6CD5\r\n}\r\n\r\nconst targetMap = new WeakMap(); // \u8BB0\u5F55\u4F9D\u8D56\u5173\u7CFB\r\nexport function track(target, type, key) {\r\n  console.log('\u89E6\u53D1\u4F9D\u8D56\u6536\u96C6');\r\n  if (activeEffect) {\r\n    // activeEffect\u5B58\u5728 \u6536\u96C6\r\n    let depsMap = targetMap.get(target); // \u53D6\u4E00\u4E0Btarget\r\n    if (!depsMap) {\r\n      // \u5982\u679Ctarget\u6CA1\u6709\u88AB\u6536\u96C6\u8FC7\r\n      targetMap.set(target, (depsMap = new Map())); // \u521B\u5EFA\u4E00\u4E2A\u5BF9\u5E94\u5173\u7CFB target: {key: }\r\n    }\r\n    let dep = depsMap.get(key); // \u53D6\u4E00\u4E0B\u5BF9\u5E94\u7684key \u6CA1\u6536\u96C6\u8FC7\u5C31\u662Fundefined\r\n    if (!dep) {\r\n      // \u6CA1\u6536\u96C6\u8FC7\r\n      depsMap.set(key, (dep = new Set())); // \u521B\u5EFAkey\u4E0Eeffect\u7684\u5BF9\u5E94\u5173\u7CFB\r\n    }\r\n    let shouldTrack = !dep.has(activeEffect); // \u770B\u4E00\u4E0B\u5BF9\u5E94\u7684key\u662F\u5426\u5DF2\u7ECF\u5EFA\u7ACB\u4E86\u548Ceffect\u7684\u5173\u7CFB\r\n    if (shouldTrack) {\r\n      // \u6CA1\u5EFA\u7ACB\u8FC7\r\n      dep.add(activeEffect); // \u5EFA\u7ACB\u4E0B\r\n      activeEffect.deps.push(dep); // effect\u4E5F\u6536\u96C6\u4E0Bkey\u548Ceffect\u7684\u5173\u7CFB\r\n    }\r\n  }\r\n}\r\n\r\nexport function trigger(target, type, key?, newValue?, oldValue?) {\r\n  const depsMap = targetMap.get(target);\r\n  if(!depsMap){\r\n    return;\r\n  }\r\n  const effects = depsMap.get(key);\r\n  effects && effects.forEach(effect => {\r\n    if (effect !== activeEffect) effect.run();\r\n  })\r\n}\r\n\r\n\r\n// \u4F9D\u8D56\u6536\u96C6\u7684\u7ED3\u6784\r\n// {\r\n//   target: {\r\n//     key: [effect1, effect2]\r\n//   }\r\n// }\r\n", "import { isObject } from '@vue/shared';\r\nimport { track, trigger } from './effect';\r\n\r\nconst reactiveMap = new WeakMap(); // \u7F13\u5B58\u5217\u8868-\u7F13\u5B58\u5DF2\u7ECFreactive\u7684\u6570\u636E\r\nconst enum ReactiveFlags {\r\n  IS_REACTIVE = '__v_isReactive',\r\n}\r\nconst mutableHandlers: ProxyHandler<object> = {\r\n  get(target, key, receiver) {\r\n    // receiver \u4EE3\u7406\u540E\u8FD4\u56DE\u7684proxy\u5B9E\u4F8B\r\n    // console.log(target, key, receiver, 'get');\r\n    if (key === ReactiveFlags.IS_REACTIVE) {\r\n      // \u53D6proxy\u5B9E\u4F8B\u7684ReactiveFlags.IS_REACTIVE\u5C5E\u6027 \u76F4\u63A5\u8FD4\u56DEtrue\r\n      return true;\r\n    }\r\n    const res = Reflect.get(target, key, receiver); // \u8FD9\u91CC\u5FC5\u987B\u8981\u4F7F\u7528Reflect\u8FDB\u884C\u64CD\u4F5C\uFF0C\u4FDD\u8BC1this\u6307\u5411\u6C38\u8FDC\u6307\u5411\u4EE3\u7406\u5BF9\u8C61\r\n    track(target, 'get', key); // \u53D6\u503C\u65F6\u8FDB\u884C\u4F9D\u8D56\u6536\u96C6\r\n    return res;\r\n  },\r\n  set(target, key, value, receiver) {\r\n    // console.log(target, key, value, receiver, 'set');\r\n    let oldValue = target[key];\r\n    const result = Reflect.set(target, key, value, receiver);\r\n    if (oldValue !== value) { // \u8BBE\u7F6E\u7684\u65B0\u503C\u548C\u8001\u503C\u4E0D\u540C\u89E6\u53D1\u66F4\u65B0\r\n      trigger(target, 'set', key, value, oldValue);\r\n    }\r\n    return result;\r\n  },\r\n};\r\n\r\nfunction createReactiveObject(target: object, isReadonly: boolean) {\r\n  if (target[ReactiveFlags.IS_REACTIVE]) {\r\n    // \u5B58\u5728ReactiveFlags.IS_REACTIVE\u5C5E\u6027\u8BF4\u660E\u5DF2\u7ECF\u4EE3\u7406\u8FC7 \u76F4\u63A5\u8FD4\u56DEproxy\u5B9E\u4F8B\r\n    return target;\r\n  }\r\n  if (!isObject(target)) {\r\n    // \u975EObject\u65E0\u6CD5Proxy\r\n    return target;\r\n  }\r\n  const exisitingProxy = reactiveMap.get(target); // \u4ECE\u7F13\u5B58\u5217\u8868\u4E2D\u83B7\u53D6\u672C\u6B21\u8981reactive\u7684\u76EE\u6807\r\n  if (exisitingProxy) {\r\n    // \u5982\u679C\u7F13\u5B58\u5217\u8868\u4E2D\u5B58\u5728 \u5219\u53D6\u51FA\u76F4\u63A5\u8FD4\u56DE\r\n    return exisitingProxy;\r\n  }\r\n\r\n  const proxy = new Proxy(target, mutableHandlers);\r\n  reactiveMap.set(target, proxy);\r\n  return proxy;\r\n}\r\n// \u5E38\u7528\u7684\u5C31\u662Freactive\u65B9\u6CD5\r\nexport function reactive(target: object) {\r\n  return createReactiveObject(target, false);\r\n}\r\n// \u540E\u9762\u7684\u65B9\u6CD5\uFF0C\u4E0D\u662F\u91CD\u70B9\u6211\u4EEC\u5148\u4E0D\u8FDB\u884C\u5B9E\u73B0...\r\n/*\r\nexport function shallowReactive(target: object) {\r\n    return createReactiveObject(target, false)\r\n}\r\nexport function readonly(target: object) {\r\n    return createReactiveObject(target, true)\r\n}\r\nexport function shallowReadonly(target: object) {\r\n    return createReactiveObject(target, true)\r\n}\r\n*/\r\n\r\n/**\r\n * 1. \u8C03\u7528reactive\u65B9\u6CD5\r\n * 2. reactive\u8C03\u7528createReactiveObject\u65B9\u6CD5\r\n *    2.1) \u5DF2\u7ECFproxy\u4EE3\u7406\u8FC7 \u76F4\u63A5\u8FD4\u56DEproxy\u5B9E\u4F8B\r\n *    2.2) \u672A\u88AB\u4EE3\u7406\u8FC7, \u975E\u5BF9\u8C61\u76F4\u63A5\u8FD4\u56DE\u539F\u59CB\u503C\r\n *    2.3) \u662F\u672A\u88AB\u4EE3\u7406\u8FC7\u7684\u5BF9\u8C61, \u4EE3\u7406, \u5B58\u5165\u7F13\u5B58\r\n *    2.4) \u8FD4\u56DEproxy\u5B9E\u4F8B\r\n */\r\n"],
  "mappings": ";;;;;;;;;;;;;;;;;;;;AAAA;AAAA;AAAA;AAAA;AAAA;;;ACAO,oBAAkB,OAA2C;AAClE,WAAO,OAAO,UAAU,YAAY,UAAU;AAAA,EAChD;;;ACFO,MAAI,eAAe;AAE1B,MAAM,iBAAN,MAAqB;AAAA,IAInB,YAAmB,IAAI;AAAJ;AAHnB,oBAAS;AACT,kBAAO,CAAC;AACR,oBAAS;AAAA,IACe;AAAA,IACxB,MAAM;AACJ,UAAI,CAAC,KAAK,QAAQ;AAGhB,eAAO,KAAK,GAAG;AAAA,MACjB;AAEA,UAAI;AACF,aAAK,SAAS;AACd,gBAAQ,IAAI,KAAK,QAAQ,qBAAqB;AAC9C,uBAAe;AACf,gBAAQ,IAAI,cAAc,iCAAiC;AAC3D,gBAAQ,IAAI,KAAK,QAAQ,iCAAiC;AAC1D,eAAO,KAAK,GAAG;AAAA,MACjB,UAAE;AACA,uBAAe,KAAK;AACpB,aAAK,SAAS;AAAA,MAChB;AAAA,IACF;AAAA,EACF;AAEO,kBAAgB,IAAI,SAAU;AAEnC,UAAM,UAAU,IAAI,eAAe,EAAE;AACrC,YAAQ,IAAI;AAAA,EACd;AAEA,MAAM,YAAY,oBAAI,QAAQ;AACvB,iBAAe,QAAQ,MAAM,KAAK;AACvC,YAAQ,IAAI,sCAAQ;AACpB,QAAI,cAAc;AAEhB,UAAI,UAAU,UAAU,IAAI,MAAM;AAClC,UAAI,CAAC,SAAS;AAEZ,kBAAU,IAAI,QAAS,UAAU,oBAAI,IAAI,CAAE;AAAA,MAC7C;AACA,UAAI,MAAM,QAAQ,IAAI,GAAG;AACzB,UAAI,CAAC,KAAK;AAER,gBAAQ,IAAI,KAAM,MAAM,oBAAI,IAAI,CAAE;AAAA,MACpC;AACA,UAAI,cAAc,CAAC,IAAI,IAAI,YAAY;AACvC,UAAI,aAAa;AAEf,YAAI,IAAI,YAAY;AACpB,qBAAa,KAAK,KAAK,GAAG;AAAA,MAC5B;AAAA,IACF;AAAA,EACF;AAEO,mBAAiB,QAAQ,MAAM,KAAM,UAAW,UAAW;AAChE,UAAM,UAAU,UAAU,IAAI,MAAM;AACpC,QAAG,CAAC,SAAQ;AACV;AAAA,IACF;AACA,UAAM,UAAU,QAAQ,IAAI,GAAG;AAC/B,eAAW,QAAQ,QAAQ,aAAU;AACnC,UAAI,YAAW;AAAc,gBAAO,IAAI;AAAA,IAC1C,CAAC;AAAA,EACH;;;AChEA,MAAM,cAAc,oBAAI,QAAQ;AAIhC,MAAM,kBAAwC;AAAA,IAC5C,IAAI,QAAQ,KAAK,UAAU;AAGzB,UAAI,QAAQ,oCAA2B;AAErC,eAAO;AAAA,MACT;AACA,YAAM,MAAM,QAAQ,IAAI,QAAQ,KAAK,QAAQ;AAC7C,YAAM,QAAQ,OAAO,GAAG;AACxB,aAAO;AAAA,IACT;AAAA,IACA,IAAI,QAAQ,KAAK,OAAO,UAAU;AAEhC,UAAI,WAAW,OAAO;AACtB,YAAM,SAAS,QAAQ,IAAI,QAAQ,KAAK,OAAO,QAAQ;AACvD,UAAI,aAAa,OAAO;AACtB,gBAAQ,QAAQ,OAAO,KAAK,OAAO,QAAQ;AAAA,MAC7C;AACA,aAAO;AAAA,IACT;AAAA,EACF;AAEA,gCAA8B,QAAgB,YAAqB;AACjE,QAAI,OAAO,qCAA4B;AAErC,aAAO;AAAA,IACT;AACA,QAAI,CAAC,SAAS,MAAM,GAAG;AAErB,aAAO;AAAA,IACT;AACA,UAAM,iBAAiB,YAAY,IAAI,MAAM;AAC7C,QAAI,gBAAgB;AAElB,aAAO;AAAA,IACT;AAEA,UAAM,QAAQ,IAAI,MAAM,QAAQ,eAAe;AAC/C,gBAAY,IAAI,QAAQ,KAAK;AAC7B,WAAO;AAAA,EACT;AAEO,oBAAkB,QAAgB;AACvC,WAAO,qBAAqB,QAAQ,KAAK;AAAA,EAC3C;",
  "names": []
}
